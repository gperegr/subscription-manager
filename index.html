<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Assinaturas</title>

    <!-- Custom Fonts: Bookmania and Boston -->


    <!-- Configuração de Utilitários Genéricos (Tailwind mantido para layout grid/flex, espaçamentos p-*, m-*) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Animações de Transição de Tela mantidas */
        .anim-enter {
            animation: fadeScaleIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .anim-exit {
            animation: fadeScaleOut 0.3s ease-in forwards;
        }

        @keyframes fadeScaleIn {
            from {
                opacity: 0;
                transform: scale(0.98) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fadeScaleOut {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }

            to {
                opacity: 0;
                transform: scale(0.98) translateY(-10px);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-4px);
            }

            75% {
                transform: translateX(4px);
            }
        }

        /* Estilo de Erro de Validação atualizado pro design dark */
        .input-error {
            box-shadow: 0 0 0 2px #d4183d !important;
            animation: shake 0.3s ease-in-out;
        }

        /* Removendo setas de number input */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        body {
            background-color: #000000;
            color: #FFFFFF;
            font-family: 'Boston', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .font-bookmania {
            font-family: 'Bookmania', serif;
        }

        /* Custom Select Styles */
        .select-options {
            animation: slideDown 0.2s ease-out;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-height: 280px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes morph {
            0% {
                border-radius: 60% 40% 30% 70%/60% 30% 70% 40%;
            }

            50% {
                border-radius: 30% 60% 70% 40%/50% 60% 30% 60%;
            }

            100% {
                border-radius: 60% 40% 30% 70%/60% 30% 70% 40%;
            }
        }

        .plasma-blob {
            width: 340px;
            height: 340px;
            background-color: #B9CFFE;
            animation: morph 12s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Elastic Scroll Effect */
        .scroll-reveal {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .scroll-reveal.revealed {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    </style>
</head>

<body class="min-h-screen transition-colors">

    <div class="max-w-md mx-auto px-4 py-6">

        <div id="main-view">
            <!-- Cabeçalho / Resumo (Block White #FFFFFF) -->
            <div class="p-5 rounded-[32px] mb-6 flex flex-col justify-between"
                style="background-color: #FFFFFF; min-height: 760px;">

                <!-- Plasma Blob Centered -->
                <div class="flex-1 flex items-center justify-center py-8">
                    <div class="plasma-blob">
                        <div class="text-center">
                            <p class="text-black/50 mb-2 text-sm">Gasto Total Mensal</p>
                            <p class="text-black font-bookmania font-normal text-[3.2rem] leading-none"
                                id="total-monthly-cost">
                                R$ 0,00
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Toolbar de Ordenação Integrada ao App.tsx visual -->
                <div>
                    <button onclick="toggleView('form')"
                        class="w-full px-6 py-4 rounded-[24px] bg-black text-white hover:bg-black/90 transition-colors flex items-center justify-center gap-2 font-semibold text-base mb-6">
                        <i class="fa-solid fa-plus"></i> Nova Assinatura
                    </button>

                    <label class="text-black/50 text-sm mb-3 block">Ordenar por</label>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-arrow-up-wide-short text-black/50 w-4 h-4 flex-shrink-0 text-center"></i>
                        <div class="relative flex-1 custom-select w-full" data-id="sort-select">
                            <input type="hidden" id="sort-input" value="cost-desc">
                            <button type="button"
                                class="w-full px-4 py-3 rounded-[24px] text-black border border-black/5 transition-colors focus:border-black/20 outline-none flex items-center justify-between select-button focus:ring-0 focus:outline-0 focus:shadow-none"
                                style="background-color: #F5F5F5;">
                                <span class="select-label truncate text-left text-sm">Maior Custo Mensal</span>
                                <i
                                    class="fa-solid fa-chevron-down text-black/50 text-sm transition-transform duration-200"></i>
                            </button>
                            <div
                                class="select-options hidden absolute top-full left-0 right-0 mt-2 rounded-[24px] overflow-hidden border border-black/5 z-50 bg-white overflow-y-auto w-[220px] shadow-xl">
                                <button type="button"
                                    class="select-option w-full px-5 py-3 text-left transition-all flex items-center justify-between text-[0.9375rem] text-black/70 hover:bg-black/5"
                                    data-value="name-asc">
                                    <span>Ordem Alfabética</span>
                                </button>
                                <button type="button"
                                    class="select-option w-full px-5 py-3 text-left transition-all flex items-center justify-between text-[0.9375rem] text-black border-t border-black/5 font-semibold hover:bg-black/5"
                                    data-value="cost-desc">
                                    <span>Maior Custo Mensal</span>
                                    <i class="fa-solid fa-check ml-2 text-black"></i>
                                </button>
                                <button type="button"
                                    class="select-option w-full px-5 py-3 text-left transition-all flex items-center justify-between text-[0.9375rem] text-black/70 border-t border-black/5 hover:bg-black/5"
                                    data-value="cost-asc">
                                    <span>Menor Custo Mensal</span>
                                </button>
                                <button type="button"
                                    class="select-option w-full px-5 py-3 text-left transition-all flex items-center justify-between text-[0.9375rem] text-black/70 border-t border-black/5 hover:bg-black/5"
                                    data-value="use-desc">
                                    <span>Maior Custo por Uso</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Assinaturas -->
            <div id="subscriptions-list" class="space-y-6">
                <!-- Os cartões de assinatura serão injetados aqui via JS -->
            </div>
        </div>

        <div id="form-view" class="hidden">
            <div class="w-full">
                <div class="w-full p-6 rounded-[24px]" style="background-color: #1A1C19;">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="form-title" class="text-white font-bookmania text-[1.75rem] font-normal">
                            Nova Assinatura
                        </h2>
                        <button onclick="cancelEdit()"
                            class="w-9 h-9 rounded-full bg-white/10 active:bg-white/20 flex items-center justify-center transition-colors flex-shrink-0">
                            <i class="fa-solid fa-times text-white"></i>
                        </button>
                    </div>

                    <form id="subscription-form" class="space-y-5" novalidate>
                        <div>
                            <label class="block text-white/70 mb-2 text-sm">Nome do Serviço</label>
                            <input type="text" id="sub-name" required placeholder="Ex: Netflix, Spotify..."
                                class="w-full px-4 py-3 rounded-2xl text-white border border-white/10 transition-colors focus:border-white/30 outline-none placeholder-white/30 text-base"
                                style="background-color: #080808;">
                        </div>

                        <div>
                            <label class="block text-white/70 mb-2 text-sm">Categoria</label>
                            <div class="relative custom-select" id="custom-cat">
                                <input type="hidden" id="sub-category" value="Streamings">
                                <button type="button"
                                    class="w-full px-4 py-3 rounded-2xl text-white border border-white/10 transition-colors focus:border-white/30 outline-none flex items-center justify-between select-button focus:ring-0 focus:outline-0 focus:shadow-none"
                                    style="background-color: #080808;">
                                    <span class="select-label truncate text-left text-base">Streamings</span>
                                    <i
                                        class="fa-solid fa-chevron-down text-white/50 text-sm transition-transform duration-200"></i>
                                </button>
                                <div
                                    class="select-options hidden absolute top-full left-0 right-0 mt-2 rounded-[24px] overflow-hidden border border-white/10 z-50 bg-[#1A1C19] overflow-y-auto focus:outline-none">
                                    <button type="button"
                                        class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white font-semibold hover:bg-white/10 outline-none focus:outline-none focus:ring-0"
                                        data-value="Streamings">
                                        <span>Streamings</span>
                                        <i class="fa-solid fa-check ml-2 text-white"></i>
                                    </button>
                                    <button type="button"
                                        class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                        data-value="Softwares"><span>Softwares</span></button>
                                    <button type="button"
                                        class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                        data-value="Saúde"><span>Saúde</span></button>
                                    <button type="button"
                                        class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                        data-value="Mercado"><span>Mercado</span></button>
                                    <button type="button"
                                        class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                        data-value="Educação"><span>Educação</span></button>
                                    <button type="button"
                                        class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                        data-value="Compras"><span>Compras</span></button>
                                    <button type="button"
                                        class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                        data-value="Fitness"><span>Fitness</span></button>
                                    <button type="button"
                                        class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                        data-value="Outros"><span>Outros</span></button>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-white/70 mb-2 text-sm">Valor</label>
                                <input type="number" id="sub-price" required min="0.01" step="0.01" placeholder="0.00"
                                    class="w-full px-4 py-3 rounded-2xl text-white border border-white/10 transition-colors focus:border-white/30 outline-none placeholder-white/30 text-base"
                                    style="background-color: #080808;">
                            </div>
                            <div>
                                <label class="block text-white/70 mb-2 text-sm">Período</label>
                                <div class="relative custom-select" id="custom-period">
                                    <input type="hidden" id="sub-period" value="monthly">
                                    <button type="button"
                                        class="w-full px-4 py-3 rounded-2xl text-white border border-white/10 transition-colors focus:border-white/30 outline-none flex items-center justify-between select-button focus:ring-0 focus:outline-0 focus:shadow-none"
                                        style="background-color: #080808;">
                                        <span class="select-label truncate text-left text-base">Mensal</span>
                                        <i
                                            class="fa-solid fa-chevron-down text-white/50 text-sm transition-transform duration-200"></i>
                                    </button>
                                    <div
                                        class="select-options hidden absolute top-full left-0 right-0 mt-2 rounded-[24px] overflow-hidden border border-white/10 z-50 bg-[#1A1C19] overflow-y-auto focus:outline-none">
                                        <button type="button"
                                            class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white font-semibold hover:bg-white/10 outline-none focus:outline-none"
                                            data-value="monthly">
                                            <span>Mensal</span>
                                            <i class="fa-solid fa-check ml-2 text-white"></i>
                                        </button>
                                        <button type="button"
                                            class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                            data-value="yearly"><span>Anual</span></button>
                                        <button type="button"
                                            class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                            data-value="weekly"><span>Semanal</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 pb-2">
                            <div>
                                <label class="block text-white/70 mb-2 text-sm">Frequência</label>
                                <input type="number" id="sub-usage-count" min="0" step="1" placeholder="Ex: 12"
                                    class="w-full px-4 py-3 rounded-2xl text-white border border-white/10 transition-colors focus:border-white/30 outline-none placeholder-white/30 text-base"
                                    style="background-color: #080808;">
                            </div>
                            <div>
                                <label class="block text-white/70 mb-2 text-sm">Período</label>
                                <div class="relative custom-select" id="custom-usage-period">
                                    <input type="hidden" id="sub-usage-period" value="monthly">
                                    <button type="button"
                                        class="w-full px-4 py-3 rounded-2xl text-white border border-white/10 transition-colors focus:border-white/30 outline-none flex items-center justify-between select-button focus:ring-0 focus:outline-0 focus:shadow-none"
                                        style="background-color: #080808;">
                                        <span class="select-label truncate text-left text-base">Mês</span>
                                        <i
                                            class="fa-solid fa-chevron-down text-white/50 text-sm transition-transform duration-200"></i>
                                    </button>
                                    <div
                                        class="select-options hidden absolute top-full left-0 right-0 mt-2 rounded-[24px] overflow-hidden border border-white/10 z-50 bg-[#1A1C19] overflow-y-auto w-full focus:outline-none">
                                        <button type="button"
                                            class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 hover:bg-white/10 outline-none focus:outline-none"
                                            data-value="daily"><span>Dia</span></button>
                                        <button type="button"
                                            class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                            data-value="weekly"><span>Semana</span></button>
                                        <button type="button"
                                            class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white font-semibold border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                            data-value="monthly">
                                            <span>Mês</span>
                                            <i class="fa-solid fa-check ml-2 text-white"></i>
                                        </button>
                                        <button type="button"
                                            class="select-option w-full px-5 py-3.5 text-left transition-all flex items-center justify-between text-[0.9375rem] text-white/70 border-t border-white/5 hover:bg-white/10 outline-none focus:outline-none"
                                            data-value="yearly"><span>Ano</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-white/50 mt-1 mb-4 text-[0.8125rem]">Opcional. Ajuda a calcular custo por uso</p>

                        <div class="space-y-3 pt-2">
                            <button type="submit" id="submit-btn"
                                class="w-full py-3 rounded-full bg-white text-black active:bg-white/90 transition-colors font-semibold">
                                Adicionar Assinatura
                            </button>
                            <button type="button" onclick="cancelEdit()"
                                class="w-full py-3 rounded-full bg-white/10 text-white active:bg-white/20 transition-colors font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Custom Dropdown Logic
        function setupCustomDropdowns() {
            document.querySelectorAll('.custom-select').forEach(dropdown => {
                const button = dropdown.querySelector('.select-button');
                const label = button.querySelector('.select-label');
                const optionsMenu = dropdown.querySelector('.select-options');
                const options = optionsMenu.querySelectorAll('.select-option');
                const hiddenInput = dropdown.querySelector('input[type="hidden"]');
                const arrow = button.querySelector('.fa-chevron-down');

                // Toggle menu
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = !optionsMenu.classList.contains('hidden');

                    // Close all others
                    document.querySelectorAll('.select-options').forEach(menu => menu.classList.add('hidden'));
                    document.querySelectorAll('.select-button').forEach(btn => btn.style.borderColor = 'rgba(255, 255, 255, 0.1)');
                    document.querySelectorAll('.fa-chevron-down').forEach(icon => icon.style.transform = 'rotate(0deg)');

                    if (!isOpen) {
                        optionsMenu.classList.remove('hidden');
                        button.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                        arrow.style.transform = 'rotate(180deg)';
                    }
                });

                // Select option
                options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Update UI
                        label.textContent = option.querySelector('span').textContent.trim();

                        // Handle styles
                        options.forEach(opt => {
                            opt.style.color = 'rgba(255, 255, 255, 0.7)';
                            opt.classList.remove('font-semibold');
                            const check = opt.querySelector('.fa-check');
                            if (check) check.remove();
                        });

                        option.style.color = '#FFFFFF';
                        option.classList.add('font-semibold');
                        option.innerHTML += ' <i class="fa-solid fa-check ml-2 text-white"></i>';

                        // Update value
                        hiddenInput.value = option.dataset.value;

                        // Trigger change event if needed
                        const event = new Event('change');
                        hiddenInput.dispatchEvent(event);

                        // Close dropdown
                        optionsMenu.classList.add('hidden');
                        button.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                        arrow.style.transform = 'rotate(0deg)';
                    });
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                document.querySelectorAll('.select-options').forEach(menu => menu.classList.add('hidden'));
                document.querySelectorAll('.select-button').forEach(btn => btn.style.borderColor = 'rgba(255, 255, 255, 0.1)');
                document.querySelectorAll('.fa-chevron-down').forEach(icon => icon.style.transform = 'rotate(0deg)');
            });
        }

        function setDropdownValue(dropdownId, value) {
            const hiddenInput = document.getElementById(dropdownId);
            if (!hiddenInput) return;
            const dropdown = hiddenInput.closest('.custom-select');
            if (!dropdown) return;
            const options = dropdown.querySelectorAll('.select-option');
            const label = dropdown.querySelector('.select-label');

            const optionToSelect = Array.from(options).find(opt => opt.dataset.value === value) || options[0];

            if (optionToSelect) {
                // Manually trigger the click logic without opening
                label.textContent = optionToSelect.querySelector('span').textContent.trim();

                options.forEach(opt => {
                    opt.style.color = 'rgba(255, 255, 255, 0.7)';
                    opt.classList.remove('font-semibold');
                    const check = opt.querySelector('.fa-check');
                    if (check) check.remove();
                });

                optionToSelect.style.color = '#FFFFFF';
                optionToSelect.classList.add('font-semibold');
                optionToSelect.innerHTML += ' <i class="fa-solid fa-check ml-2 text-white"></i>';

                hiddenInput.value = optionToSelect.dataset.value;
            }
        }

        // Intersection Observer (moved to initialization section)

        // Estado inicial
        let subscriptions = [
            {
                id: 1,
                name: "Netflix",
                category: "Streamings",
                price: 55.90,
                period: "monthly",
                usageCount: 20,
                usagePeriod: "monthly"
            },
            {
                id: 2,
                name: "Spotify",
                category: "Streamings",
                price: 21.90,
                period: "monthly",
                usageCount: 30,
                usagePeriod: "monthly"
            },
            {
                id: 3,
                name: "Adobe Creative Cloud",
                category: "Softwares",
                price: 299.00,
                period: "monthly",
                usageCount: 12,
                usagePeriod: "monthly"
            },
            {
                id: 4,
                name: "Duolingo Plus",
                category: "Educação",
                price: 239.88,
                period: "yearly",
                usageCount: 25,
                usagePeriod: "yearly"
            }
        ];

        // Formatador de Moeda
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        // Traduções visuais
        const periodTranslations = {
            'monthly': '/mês',
            'yearly': '/ano',
            'weekly': '/sem',
            'daily': '/dia'
        };

        const usagePeriodLabels = {
            'daily': 'por dia',
            'weekly': 'por semana',
            'monthly': 'por mês',
            'yearly': 'por ano'
        };

        // Cores pastéis baseadas no App.tsx
        const PASTEL_COLORS = ['#B9CFFE', '#EDE1F5', '#FFE0E1', '#F4EFE6'];
        const DARK_TEXT_COLORS = ['#091F4D', '#240D33', '#3D0A0C', '#2E2719'];

        // Estado da interface
        let editingId = null;
        let currentSort = 'cost-desc';

        // Gerenciamento de Telas
        window.toggleView = (viewName) => {
            const mainView = document.getElementById('main-view');
            const formView = document.getElementById('form-view');

            const entering = viewName === 'form' ? formView : mainView;
            const leaving = viewName === 'form' ? mainView : formView;

            leaving.classList.remove('anim-enter');
            leaving.classList.add('anim-exit');

            setTimeout(() => {
                leaving.classList.add('hidden');
                leaving.classList.remove('anim-exit');

                entering.classList.remove('hidden');
                entering.classList.add('anim-enter');
            }, 280);
        };

        window.changeSort = (sortValue) => {
            currentSort = sortValue;
            window.renderSubscriptions(); // Call the wrapped renderSubscriptions
        };

        // Lógica de Cálculo aprimorada (unificando com uso e período original)
        const calculateMetrics = (sub) => {
            let monthlyCost = 0;
            let costPerUse = 0;

            if (sub.period === 'monthly') monthlyCost = sub.price;
            else if (sub.period === 'yearly') monthlyCost = sub.price / 12;
            else if (sub.period === 'weekly') monthlyCost = sub.price * 4.33;

            if (sub.usageCount > 0) {
                // Cálculo adaptado: Se usagePeriod for igual ao period, calculamos por período (igual a App.tsx)
                let usagesPerMonth = 0;
                if (sub.usagePeriod === 'daily') usagesPerMonth = sub.usageCount * 30;
                else if (sub.usagePeriod === 'weekly') usagesPerMonth = sub.usageCount * 4.33;
                else if (sub.usagePeriod === 'monthly') usagesPerMonth = sub.usageCount;
                else if (sub.usagePeriod === 'yearly') usagesPerMonth = sub.usageCount / 12;

                costPerUse = monthlyCost / usagesPerMonth;
            }

            return {
                monthlyCost,
                costPerUse
            };
        };

        // Renderizar Lista e Totais
        const renderSubscriptions = () => {
            const listEl = document.getElementById('subscriptions-list');
            const totalEl = document.getElementById('total-monthly-cost');

            listEl.innerHTML = '';
            let totalMonthlyCost = 0;

            if (subscriptions.length === 0) {
                listEl.innerHTML = `
                    <div class="p-8 rounded-[24px] text-center" style="background-color: #1A1C19;">
                        <p class="text-white/50 text-base">Nenhuma assinatura cadastrada ainda.</p>
                        <p class="text-white/30 mt-2 text-sm">Clique em "Nova Assinatura" para começar</p>
                    </div>
                `;
                totalEl.textContent = formatCurrency(0);
                return;
            }

            // Aplicar ordenação
            let sortedSubs = [...subscriptions];
            sortedSubs.sort((a, b) => {
                const metricsA = calculateMetrics(a);
                const metricsB = calculateMetrics(b);
                if (currentSort === 'cost-desc') return metricsB.monthlyCost - metricsA.monthlyCost;
                if (currentSort === 'cost-asc') return metricsA.monthlyCost - metricsB.monthlyCost;
                if (currentSort === 'use-desc') return metricsB.costPerUse - metricsA.costPerUse;
                if (currentSort === 'name-asc') return a.name.localeCompare(b.name);
                return 0;
            });

            // Agrupar assinaturas por categoria
            const groupedSubs = sortedSubs.reduce((acc, sub) => {
                if (!acc[sub.category]) acc[sub.category] = [];
                acc[sub.category].push(sub);

                const metrics = calculateMetrics(sub);
                totalMonthlyCost += metrics.monthlyCost;

                return acc;
            }, {});

            let categoryIndex = 0;

            // Renderizar cada grupo
            Object.entries(groupedSubs).forEach(([category, subs]) => {
                const colorIndex = categoryIndex % PASTEL_COLORS.length;
                const categoryColor = PASTEL_COLORS[colorIndex];
                const textColor = DARK_TEXT_COLORS[colorIndex];
                categoryIndex++;

                const categoryTotal = subs.reduce((sum, sub) => sum + calculateMetrics(sub).monthlyCost, 0);
                const categorySection = document.createElement('div');

                // Header da Categoria
                const categoryHTML = `
                    <div class="flex justify-between items-end mb-3 ml-1">
                        <h2 class="text-white font-bookmania text-2xl font-normal">
                            ${category}
                        </h2>
                        <span class="text-white/50 text-sm font-medium mb-1">
                            ${formatCurrency(categoryTotal)}
                        </span>
                    </div>
                    <div class="space-y-3" id="cat-list-${category.replace(/[^a-zA-Z0-9]/g, '-')}" style="margin-bottom: 12px;"></div>
                `;
                categorySection.innerHTML = categoryHTML;
                listEl.appendChild(categorySection);

                const catListEl = categorySection.querySelector(`#cat-list-${category.replace(/[^a-zA-Z0-9]/g, '-')}`);

                // Cartões de Assinatura
                subs.forEach((sub) => {
                    const metrics = calculateMetrics(sub);
                    // Contêiner principal do Card
                    const card = document.createElement('div');
                    card.className = `relative p-5 rounded-[32px] mb-3 flex flex-col justify-between scroll-reveal transition-transform active:scale-[0.98]`;
                    card.style.backgroundColor = categoryColor;
                    card.style.color = textColor;
                    card.style.minHeight = '140px';

                    // Ajuste de apresentação de custo de uso e vezes (igual ao react App.tsx)
                    let usageHtml = '';
                    if (sub.usageCount > 0) {
                        const usageLabel = usagePeriodLabels[sub.usagePeriod] || 'no período';
                        usageHtml = `
                            <div class="flex justify-between items-baseline gap-2">
                                <span style="color: ${textColor}; opacity: 0.7; font-size: 0.8125rem;">Uso:</span>
                                <span style="color: ${textColor}; font-weight: 500; font-size: 0.9375rem;">${sub.usageCount}x ${usageLabel}</span>
                            </div>
                            <div class="flex justify-between items-baseline gap-2 pt-2 border-t border-black/10">
                                <span style="color: ${textColor}; opacity: 0.7; font-size: 0.8125rem;">Custo por Uso:</span>
                                <span style="color: ${textColor}; font-weight: 600; font-size: 1.125rem;">${formatCurrency(metrics.costPerUse)}</span>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        <!-- Action Buttons -->
                        <div class="absolute top-3 right-3 flex gap-2">
                            <button onclick="editSubscription(${sub.id})" class="w-9 h-9 rounded-full bg-black/10 active:bg-black/20 flex items-center justify-center transition-colors" style="color: ${textColor};">
                                <i class="fa-solid fa-pen text-sm"></i>
                            </button>
                            <button onclick="deleteSubscription(${sub.id})" class="w-9 h-9 rounded-full bg-black/10 active:bg-black/20 flex items-center justify-center transition-colors" style="color: ${textColor};">
                                <i class="fa-solid fa-trash text-sm"></i>
                            </button>
                        </div>

                        <!-- Content -->
                        <div class="pr-24">
                        <h3 class="mb-3 font-bookmania" style="color: ${textColor}; font-size: 1.375rem; font-weight: 400; line-height: 1.3;">
                    ${sub.name}
                </h3>

                <div class="space-y-2">
                    <div class="flex justify-between items-baseline gap-2">
                        <span style="color: ${textColor}; opacity: 0.7; font-size: 0.8125rem;">Custo Original:</span>
                        <span style="color: ${textColor}; font-weight: 500; font-size: 0.9375rem;">${formatCurrency(sub.price)}${periodTranslations[sub.period]}</span>
                    </div>
                    <div class="flex justify-between items-baseline gap-2">
                        <span style="color: ${textColor}; opacity: 0.7; font-size: 0.8125rem;">Custo Mensal:</span>
                        <span style="color: ${textColor}; font-weight: 600; font-size: 1.125rem;">${formatCurrency(metrics.monthlyCost)}</span>
                    </div>
                    ${usageHtml}
                </div>
            </div>
                    `;
                    catListEl.appendChild(card);
                });
            });

            totalEl.textContent = formatCurrency(totalMonthlyCost);
        };

        // Adicionar / Editar Assinatura
        document.getElementById('subscription-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const form = e.target;

            // Validação Visual
            if (!form.checkValidity()) {
                Array.from(form.elements).forEach(field => {
                    if ((field.tagName === 'INPUT' || field.tagName === 'SELECT') && !field.checkValidity()) {
                        field.classList.remove('input-error');
                        void field.offsetWidth;
                        field.classList.add('input-error');
                        field.addEventListener('input', () => field.classList.remove('input-error'), { once: true });
                    }
                });
                return;
            }

            const usagePeriodVal = document.getElementById('sub-usage-period').value;
            const periodSelected = document.getElementById('sub-period').value;

            const newSub = {
                id: editingId ? editingId : Date.now(),
                name: document.getElementById('sub-name').value,
                category: document.getElementById('sub-category').value,
                price: parseFloat(document.getElementById('sub-price').value),
                period: periodSelected,
                usageCount: document.getElementById('sub-usage-count').value ? parseInt(document.getElementById('sub-usage-count').value) : 0,
                usagePeriod: usagePeriodVal
            };

            if (editingId) {
                const index = subscriptions.findIndex(s => s.id === editingId);
                if (index !== -1) subscriptions[index] = newSub;
                cancelEdit();
            } else {
                subscriptions.push(newSub);
                document.getElementById('sub-name').value = '';
                document.getElementById('sub-price').value = '';
                document.getElementById('sub-usage-count').value = '';
            }

            // Select elements do not automatically reset empty on some browsers manually set to initial
            setDropdownValue('sub-category', "Streamings");
            setDropdownValue('sub-period', "monthly");
            setDropdownValue('sub-usage-period', "monthly");

            toggleView('main');
            render();
        });

        // Entrar no modo de edição
        window.editSubscription = (id) => {
            const sub = subscriptions.find(s => s.id === id);
            if (!sub) return;

            document.getElementById('sub-name').value = sub.name;
            setDropdownValue('sub-category', sub.category);
            document.getElementById('sub-price').value = sub.price;
            setDropdownValue('sub-period', sub.period);
            document.getElementById('sub-usage-count').value = sub.usageCount > 0 ? sub.usageCount : '';
            setDropdownValue('sub-usage-period', sub.usagePeriod || sub.period || 'monthly');

            editingId = id;

            document.getElementById('form-title').innerText = 'Editar Assinatura';
            document.getElementById('submit-btn').innerText = 'Salvar Alterações';

            toggleView('form');
        };

        // Cancelar modo de edição
        window.cancelEdit = () => {
            editingId = null;
            document.getElementById('sub-name').value = '';
            document.getElementById('sub-price').value = '';
            document.getElementById('sub-usage-count').value = '';

            document.getElementById('form-title').innerText = 'Nova Assinatura';
            document.getElementById('submit-btn').innerText = 'Adicionar Assinatura';

            // force defaults
            setDropdownValue('sub-category', "Streamings");
            setDropdownValue('sub-period', "monthly");
            setDropdownValue('sub-usage-period', "monthly");

            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

            toggleView('main');
        };

        // Remover Assinatura
        window.deleteSubscription = (id) => {
            if (confirm('Tem certeza que deseja remover esta assinatura?')) {
                subscriptions = subscriptions.filter(sub => sub.id !== id);
                if (editingId === id) cancelEdit();
                window.renderSubscriptions(); // Changed render() to window.renderSubscriptions()
            }
        };


        // --- Initialization & Interactions ---

        // MutationObserver to reveal cards as they are added to the list
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('revealed');
                }
            });
        }, { threshold: 0.1 });

        const observeCards = () => {
            document.querySelectorAll('.scroll-reveal').forEach(card => observer.observe(card));
        };

        // Wrap renderSubscriptions to trigger observer
        const baseRender = renderSubscriptions;
        window.renderSubscriptions = () => {
            baseRender();
            observeCards();
        };

        document.addEventListener('DOMContentLoaded', () => {
            setupCustomDropdowns();

            // Setup sort input change
            const sortInput = document.getElementById('sort-input');
            if (sortInput) {
                sortInput.addEventListener('change', (e) => {
                    window.changeSort(e.target.value);
                });
            }

            // Default values
            setDropdownValue('sub-category', "Streamings");
            setDropdownValue('sub-period', "monthly");
            setDropdownValue('sort-input', "cost-desc");

            // Initial render
            window.renderSubscriptions();
        });
    </script>
</body>

</html>